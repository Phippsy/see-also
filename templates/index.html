<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>See Also</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; }
        h1, h2 { font-family: 'Poppins', sans-serif; }
        :root {
            --primary: #6366f1;
            --secondary: #0ea5e9;
            --accent: #f43f5e;
            --bg: #f0f4f8;
        }
        #tooltip { pointer-events: none; }
        #notification { transition: opacity 0.3s; }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="bg-[var(--bg)] min-h-screen">
    <div class="p-4">
        <form method="post" class="flex items-start space-x-2">
            <textarea id="text" name="text" rows="2" placeholder="Enter a concept" required class="p-2 border rounded w-1/3">{{ user_text }}</textarea>
            <button type="submit" class="px-4 py-2 bg-[var(--primary)] text-white rounded hover:bg-indigo-700">Generate</button>
        </form>
    </div>
    <div id="graph" class="relative w-full h-[600px]"></div>
    <div id="tooltip" class="absolute bg-white border rounded shadow-lg p-4 hidden"></div>
    <div id="notification" class="fixed top-4 right-4 bg-gray-800 text-white px-4 py-2 rounded shadow-lg hidden"></div>

    <script>
        const notifyEl = document.getElementById('notification');
        function showNotification(msg, error=false) {
            notifyEl.textContent = msg;
            notifyEl.style.backgroundColor = error ? 'var(--accent)' : 'var(--primary)';
            notifyEl.classList.remove('hidden');
        }
        function hideNotification() { notifyEl.classList.add('hidden'); }

        const formEl = document.querySelector('form');
        formEl.addEventListener('submit', () => {
            showNotification('Generating concepts...');
        });
    </script>

    {% if concepts %}
    <script>
        const data = {{ concepts | tojson | safe }};
        const rootText = {{ user_text | tojson | safe }};
        const graphDiv = document.getElementById('graph');
        let width = graphDiv.clientWidth;
        let height = graphDiv.clientHeight;
        let baseRadius = Math.max(20, Math.min(width, height) * 0.05);
        const nodes = [{id: 'root', label: rootText, fx: width/2, fy: height/2, depth: 0}];
        const links = [];
        data.forEach((c, i) => {
            nodes.push({id: i, label: c.short_name, info: c, depth: 1});
            links.push({source: 'root', target: i});
        });
        const svg = d3.select('#graph').append('svg')
            .attr('width', width)
            .attr('height', height);
        const container = svg.append('g');
        const zoomBehavior = d3.zoom().scaleExtent([0.5, 2]).on('zoom', event => {
            container.attr('transform', event.transform);
        });
        svg.call(zoomBehavior);

        let simulation = d3.forceSimulation(nodes)
            .force('link', d3.forceLink(links).id(d => d.id).distance(120))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width/2, height/2));

        let link = container.append('g').selectAll('line');
        let node = container.append('g').selectAll('g');

        function radiusByDepth(depth) {
            return baseRadius * Math.max(0.5, 1 - depth * 0.15);
        }

        let idCounter = nodes.length;

        function update() {
            link = link.data(links);
            link.exit().remove();
            link = link.enter().append('line')
                .attr('stroke', '#ccc')
                .merge(link);

            node = node.data(nodes, d => d.id);
            const nodeEnter = node.enter().append('g')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            nodeEnter.append('circle')
                .attr('r', d => d.id === 'root' ? baseRadius * 1.3 : radiusByDepth(d.depth || 1))
                .attr('fill', (d,i) => d.id === 'root' ? 'var(--primary)' : 'var(--secondary)')
                .on('mousemove', showTooltip)
                .on('mouseout', hideTooltip);

            nodeEnter.append('text')
                .text('+')
                .attr('class', 'text-xs cursor-pointer select-none')
                .attr('x', d => (d.id === 'root' ? baseRadius*1.3 : radiusByDepth(d.depth || 1)) * 0.7)
                .attr('y', d => -(d.id === 'root' ? baseRadius*1.3 : radiusByDepth(d.depth || 1)) * 0.7)
                .on('click', expandNode);

            nodeEnter.append('text')
                .text(d => d.label)
                .attr('text-anchor', 'middle')
                .attr('dy', d => (d.id === 'root' ? baseRadius*1.3 : radiusByDepth(d.depth || 1)) + 12)
                .attr('class', 'text-xs pointer-events-none');

            node = nodeEnter.merge(node);

            simulation.nodes(nodes);
            simulation.force('link').links(links);
            simulation.alpha(1).restart();
        }

        function resize() {
            width = graphDiv.clientWidth;
            height = graphDiv.clientHeight;
            svg.attr('width', width).attr('height', height);
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            baseRadius = Math.max(20, Math.min(width, height) * 0.05);
            simulation.alpha(1).restart();
        }

        update();
        window.addEventListener('resize', resize);

        simulation.on('tick', () => {
            link.attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            node.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        const tooltip = document.getElementById('tooltip');
        function showTooltip(event, d) {
            if(!d.info) return;
            tooltip.innerHTML = `<h2 class='font-bold mb-1'>${d.label}</h2>` +
                `<p class='text-sm mb-1'><strong>Definition:</strong> ${d.info.definition}</p>` +
                `<p class='text-sm mb-1'>${d.info.explanation}</p>` +
                `<p class='text-sm'><strong>Start here:</strong> ${d.info.start_here}</p>`;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
            tooltip.classList.remove('hidden');
        }
        function hideTooltip() { tooltip.classList.add('hidden'); }
        function dragstarted(event) { if (!event.active) simulation.alphaTarget(0.3).restart(); event.subject.fx = event.subject.x; event.subject.fy = event.subject.y; }
        function dragged(event) { event.subject.fx = event.x; event.subject.fy = event.y; }
        function dragended(event) { if (!event.active) simulation.alphaTarget(0); event.subject.fx = null; event.subject.fy = null; }

        async function expandNode(event, d) {
            event.stopPropagation();
            showNotification('Generating concepts...');
            try {
                const res = await fetch('/expand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: d.label })
                });
                if (!res.ok) throw new Error('Request failed');
                const result = await res.json();
                const concepts = result.concepts || [];
                concepts.forEach(c => {
                    const newNode = { id: idCounter++, label: c.short_name, info: c, depth: (d.depth || 0) + 1 };
                    nodes.push(newNode);
                    links.push({ source: d.id, target: newNode.id });
                });
                update();
            } catch (e) {
                showNotification('Error generating concepts', true);
                setTimeout(hideNotification, 2000);
                return;
            }
            hideNotification();
        }
    </script>
    {% endif %}
</body>
</html>
